<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <!--/*@thymesVar id="individu" type="org.esupportail.esupagape.entity.Individu"*/-->
    <!--/*@thymesVar id="currentDossier" type="org.esupportail.esupagape.entity.Dossier"*/-->
    <head th:replace="fragments/head :: head"></head>
    <body>
        <header th:replace="fragments/header :: header"></header>
        <main class="d-inline-flex">
            <div th:replace="fragments/side :: side"></div>
            <div class="agape-content agape-content-side">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a th:href="@{/dossiers}" class="text-center ">Liste des dossiers</a>
                        </li>
                    </ol>
                </nav>
                <div th:replace="fragments/tabs-years :: tabs-years"></div>
                <div th:replace="fragments/tabs-content :: tabs-content(active='dossier')"></div>
                <div class="m-3">
                    <form id="form-dossier" class="mb-1" th:action="@{'/dossiers/' + ${currentDossier.id}}" th:method="put" th:object="${currentDossier}">
                        <div class="row">
                            <div class="col-6">
                                <h4>Situation</h4>
                                <hr>
                                <div class="row mb-1 align-items-baseline">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label select-label" th:for="classification">Classification du handicap</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <select multiple id="classification" disabled th:field="*{classification}" size="1" type="text" class="agape-slim-select-search" th:value="${currentDossier.classification}">
                                            <option type="text"
                                                    th:checked="${currentDossier.classification.contains(classification)}"
                                                    th:each="classification : ${classifications}"
                                                    th:text="#{'dossier.classification.' +${classification}}"
                                                    th:value="${classification}"></option>
                                        </select>
                                    </div>
                                </div>
                                <!--                    <div class="row mb-1 align-items-baseline">-->
                                <!--                        <div class="col-4" style="width: 250px;">-->
                                <!--                        <label class="form-label" for="etat">Etat</label>-->
                                <!--                        </div>-->
                                <!--                        <div class="col-12 col-xxl-8">-->
                                <!--                        <select disabled id="etat" name="etat" type="text" class="form-select" th:value="${currentDossier.etat}">-->
                                <!--                            <option value="" disabled selected>Choisir</option>-->
                                <!--                            <option th:selected="${currentDossier.etat == etat}" th:each="etat : ${etats}" th:text="#{'dossier.etat.' +${etat}}" th:value="${etat}"></option>-->
                                <!--                        </select>-->
                                <!--                        </div>-->
                                <!--                    </div>-->
                                <div class="row mb-1 align-items-baseline">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="mdph">Suivi MDPH</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <select disabled id="mdph" name="mdph" type="text" class="form-select" th:value="${currentDossier.mdph}">
                                            <option value="" disabled selected>Choisir</option>
                                            <option th:selected="${currentDossier.mdph == mdph}" th:each="mdph : ${mdphs}" th:text="#{'dossier.mdph.' +${mdph}}" th:value="${mdph}"></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-1 align-items-baseline">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="taux">Taux</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <select disabled id="taux" name="taux" type="text" class="form-select" th:value="${currentDossier.taux}">
                                            <option value="" disabled selected>Choisir</option>
                                            <option th:selected="${currentDossier.taux == taux}" th:each="taux : ${tauxs}" th:text="#{'dossier.taux.' +${taux}}" th:value="${taux}"></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-1 align-items-baseline">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="suiviHandisupOui">Suivi handisup</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <input disabled
                                                type="radio"
                                                class="form-check-input"
                                                id="suiviHandisupOui"
                                                name="suiviHandisup"
                                                value="true"
                                                th:checked="${currentDossier.suiviHandisup == true}">
                                        <label class="form-check-label" for="suiviHandisupOui">
                                            Oui
                                        </label>
                                        <input disabled
                                                type="radio"
                                                class="form-check-input"
                                                id="suiviHandisupNon"
                                                name="suiviHandisup"
                                                value="false"
                                                th:checked="${currentDossier.suiviHandisup == false}">
                                        <label class="form-check-label" for="suiviHandisupNon">
                                            Non
                                        </label>
                                    </div>
                                </div>
                                <div class="row mb-1 align-items-baseline"
                                        th:classappend="${currentDossier.suiviHandisup == null    || currentDossier.suiviHandisup == false ? 'd-none' : ''}"
                                        id="typeSuiviHandisupDiv">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" th:for="${typeSuiviHandisup}">Types de suivi handisup</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <th:block th:each="typeSuiviHandisup : ${typeSuiviHandisups}">
                                            <div class="form-check">
                                                <input disabled
                                                        type="checkbox"
                                                        class="form-check-input"
                                                        th:id="${typeSuiviHandisup}"
                                                        name="typeSuiviHandisup"
                                                        th:value="${typeSuiviHandisup}"
                                                        th:checked="${currentDossier.typeSuiviHandisup.contains(typeSuiviHandisup)}">
                                                <label class="form-check-label" th:for="${typeSuiviHandisup}" th:text="#{'dossier.typeSuiviHandisup.' +${typeSuiviHandisup}}"></label>
                                            </div>
                                        </th:block>
                                    </div>
                                </div>
                                <div class="row mb-1 align-items-baseline">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="commentaire">Commentaire</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <textarea disabled
                                                id="commentaire"
                                                name="commentaire"
                                                type="text"
                                                class="form-control"
                                                th:value="${currentDossier.commentaire}"
                                                th:text="${currentDossier.commentaire}"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <h4>Parcours</h4>
                                <hr>
                                <div class="row mb-1 align-items-baseline" th:if="${currentDossier.type == T(org.esupportail.esupagape.entity.enums.TypeIndividu).ETUDIANT}">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="typeFormation">Type de formation</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <select disabled id="typeFormation" name="typeFormation" type="text" class="form-select" th:value="${currentDossier.typeFormation}">
                                            <option value="" disabled selected>Choisir</option>
                                            <option th:selected="${currentDossier.typeFormation == typeFormation}"
                                                    th:each="typeFormation : ${typeFormations}"
                                                    th:text="#{'enquete.typeFrmn.' +${typeFormation}}"
                                                    th:value="${typeFormation}"></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-1 align-items-baseline" th:if="${currentDossier.type == T(org.esupportail.esupagape.entity.enums.TypeIndividu).ETUDIANT}">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="modeFormation">Modalités de formation</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <select disabled id="modeFormation" name="modeFormation" type="text" class="form-select" th:value="${currentDossier.modeFormation}">
                                            <option value="" disabled selected>Choisir</option>
                                            <option th:selected="${currentDossier.modeFormation == modeFormation}"
                                                    th:each="modeFormation : ${modeFormations}"
                                                    th:text="#{'enquete.modFrmn.' +${modeFormation}}"
                                                    th:value="${modeFormation}"></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-1 align-items-baseline">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="site">Établissement</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <div class="input-group">
                                            <input disabled id="site" name="site" type="text" class="form-control" th:value="${currentDossier.site}" th:readonly="${currentDossier.site != ''}">
                                            <a onclick="toggleInputLock('site');"
                                                    role="button"
                                                    id="siteEdit"
                                                    class="btn btn-light border-secondary border-opacity-25 d-none"
                                                    th:if="${currentDossier.type != T(org.esupportail.esupagape.entity.enums.TypeIndividu).ETUDIANT}">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-1 align-items-baseline">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="libelleFormation">Formation</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <div class="input-group">
                                            <textarea rows="3"
                                                    disabled
                                                    id="libelleFormation"
                                                    name="libelleFormation"
                                                    class="form-control"
                                                    style="min-height:60px; resize: none;"
                                                    th:text="${currentDossier.libelleFormation}"
                                                    th:readonly="${currentDossier.libelleFormation != ''}"></textarea>
                                            <a onclick="toggleInputLock('libelleFormation');"
                                                    role="button"
                                                    id="libelleFormationEdit"
                                                    class="btn btn-light border-secondary border-opacity-25 d-none"
                                                    th:if="${currentDossier.type != T(org.esupportail.esupagape.entity.enums.TypeIndividu).ETUDIANT}">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-1 align-items-baseline">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="libelleFormation">Formation année précédente</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <div class="input-group">
                                            <textarea rows="3"
                                                      disabled
                                                      id="libelleFormationPrec"
                                                      name="libelleFormationPrec"
                                                      class="form-control"
                                                      style="min-height:60px; resize: none;"
                                                      th:text="${currentDossier.libelleFormationPrec}"
                                                      th:readonly="${currentDossier.libelleFormationPrec != ''}"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-1 align-items-baseline" th:if="${currentDossier.type == T(org.esupportail.esupagape.entity.enums.TypeIndividu).ETUDIANT}">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="composante">Composante</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <input disabled id="composante" type="text" class="form-control" th:value="${currentDossier.composante}" th:readonly="${currentDossier.composante != ''}">
                                    </div>
                                </div>
                                <div class="row mb-1 align-items-baseline">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="formAddress">Adresse de formation</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <div class="input-group">
                                            <input disabled
                                                    id="formAddress"
                                                    name="formAddress"
                                                    type="text"
                                                    class="form-control"
                                                    th:value="${currentDossier.formAddress}"
                                                    th:readonly="${currentDossier.formAddress != ''}">
                                            <a onclick="toggleInputLock('formAddress');"
                                                    role="button"
                                                    id="formAddressEdit"
                                                    class="btn btn-light border-secondary border-opacity-25 d-none"
                                                    th:if="${currentDossier.type != T(org.esupportail.esupagape.entity.enums.TypeIndividu).ETUDIANT}">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-1 align-items-baseline" th:if="${currentDossier.type != T(org.esupportail.esupagape.entity.enums.TypeIndividu).ETUDIANT}">
                                    <div class="col-4" style="width: 250px;">
                                        <label class="form-label" for="rentreeProchaine">Filière envisagée</label>
                                    </div>
                                    <div class="col-12 col-xxl-8">
                                        <select disabled id="rentreeProchaine" name="rentreeProchaine" type="text" class="form-select" th:value="${currentDossier.rentreeProchaine}">
                                            <option value="" disabled selected>Choisir</option>
                                            <option th:selected="${currentDossier.rentreeProchaine == rentreeProchaine}"
                                                    th:each="rentreeProchaine : ${rentreeProchaines}"
                                                    th:text="#{'dossier.rentreeProchaine.' +${rentreeProchaine}}"
                                                    th:value="${rentreeProchaine}"></option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="d-inline">
                            <div class="float-buttons">
                                <button title="Modifier les informations de l'individu" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#update-individu-modal" type="button"><i class="bi bi-person-fill-gear" style="font-size: 20px;"></i></button>
                                <button title="Voir les résultats" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#notesModal" type="button"><i class="bi bi-music-note-list"></i></button>
                                <button title="Voir les pièces jointes" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#pjModal" type="button"><i class="bi bi-paperclip"></i></button>
                                <button title="Modifier le dossier" onclick="unlockForm(this);" id="unlock-dossier" type="button" value="Modifier le dossier" class="btn btn-warning"><i class="bi bi-pencil"></i></button>
                                <button onclick="lockForm();" id="lock-dossier" type="button" value="Annuler" class="btn btn-danger d-none"><i class="bi bi-x-lg"></i></button>
                                <button id="submit-dossier" type="submit" value="Enregistrer" class="btn btn-success d-none">
                                    <svg style="color: white; width: 20px; margin-bottom: 3px; margin-left: 1px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M433.1 129.1l-83.9-83.9C342.3 38.32 327.1 32 316.1 32H64C28.65 32 0 60.65 0 96v320c0 35.35 28.65 64 64 64h320c35.35 0 64-28.65 64-64V163.9C448 152.9 441.7 137.7 433.1 129.1zM224 416c-35.34 0-64-28.66-64-64s28.66-64 64-64s64 28.66 64 64S259.3 416 224 416zM320 208C320 216.8 312.8 224 304 224h-224C71.16 224 64 216.8 64 208v-96C64 103.2 71.16 96 80 96h224C312.8 96 320 103.2 320 112V208z" fill="white"></path></svg>
                                </button>
                                <a class="btn btn-secondary" title="Synchroniser l'individu" th:href="'/dossiers/' + ${currentDossier.id} + '/sync'" ><i class="bi bi-arrow-repeat" style="font-size: 20px;"></i></a>
                            </div>
<!--                            <input onclick="unlockForm(this);" id="unlock-dossier" type="button" value="Modifier le dossier" class="btn btn-warning">-->
<!--                            <input onclick="lockForm();" id="lock-dossier" type="button" value="Annuler" class="btn btn-danger d-none">-->
<!--                            <input id="submit-dossier" type="submit" value="Enregistrer" class="btn btn-success d-none">-->
                        </div>

                    </form>

            </div>
            </div>
        </main>
        <div class="modal fade" id="notesModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Resultats</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p th:text="${extendedInfos.noteS1}"></p>
                        <p th:text="${extendedInfos.resultatS1}"></p>
                        <p th:text="${extendedInfos.noteS2}"></p>
                        <p th:text="${extendedInfos.resultatS2}"></p>
                        <p th:text="${extendedInfos.noteAnn}"></p>
                        <p th:text="${extendedInfos.resultatAnn}"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="pjModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="pjModalLabel">Pièces jointes</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                            <label th:for="date" class="form-label">Pièces jointes</label>
                            <table class="table table-striped" th:if="${attachments.size() > 0}">
                                <tr>
                                    <th>Nom</th>
                                    <th>Type</th>
                                    <th></th>
                                </tr>
                                <th:block th:each="attachment : ${attachments}">
                                    <tr>
                                        <td class="align-middle">
                                            <a th:href="'/dossiers/' + ${currentDossier.id} + '/get-attachment/' + ${attachment.id}" th:text="${attachment.fileName}"></a>
                                        </td>
                                        <td th:text="${attachment.parentType}">

                                        </td>
                                        <td class="align-middle">
                                            </form>
                                                <button th:attr="id=${attachment.id}"
                                                        data-bs-toggle="modal"
                                                        href="#"
                                                        data-bs-target="#modal-warning"
                                                        class="btn btn-danger"
                                                        th:data-bs-whatever="${currentDossier.id}"
                                                        th:data-bs-attachment="${attachment.fileName}"
                                                        th:disabled="${!#strings.equals(attachment.parentType, 'org.esupportail.esupagape.entity.Dossier')}"><i class="bi bi-trash3"></i></button>
                                        </td>
                                    </tr>
                                </th:block>
                            </table>
                            <form class="me-2" th:action="'/dossiers/' + ${currentDossier.id}  + '/add-attachments'" th:method="post" enctype="multipart/form-data">
                                <label class="form-label">Ajouter un fichier</label>
                                <input type="file" name="multipartFiles" multiple class="form-control mb-2" required>
                                <input type="submit" class="btn btn-primary" value="Ajouter">
                            </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal modal-warning fade" id="modal-warning" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="form-modal-warning" th:action="|/dossiers/dossierId/delete-attachment/attachmentId|"
                            th:method="delete">
                        <div class="modal-header">
                            <h5 class="modal-title fs-5"
                                    th:id="'delete-attachment-label'">
                                Suppression d'une pièce jointe</h5>
                            <button type="button" class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger text-center">Confirmez-vous
                                la suppression de
                                cette pièce jointe <br><span id="attachmentFileName"></span> ?
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline pull-left"
                                    data-bs-dismiss="modal">
                                Annuler
                            </button>
                            <button type="submit"
                                    class="btn btn-outline pull-left btn-danger">
                                Supprimer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
            const modalWarning = document.getElementById('modal-warning')
            const formModalWarning = document.getElementById('form-modal-warning')
            const spanAttachmentFileName = document.getElementById('attachmentFileName')

            modalWarning.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget
                const currentDossier = button.getAttribute('data-bs-whatever')
                const attachmentFileName = button.getAttribute('data-bs-attachment')
                formModalWarning.action = '/dossiers/'+currentDossier+'/delete-attachment/'+button.id
                spanAttachmentFileName.textContent = attachmentFileName
            })
        </script>

        <script th:if="${returnModPJ}">
            document.getElementById('pjModal').classList.toggle("fade");
            new bootstrap.Modal(document.getElementById('pjModal')).show();
            document.getElementById('pjModal').classList.toggle("fade");
        </script>
        <footer th:replace="fragments/footer :: black"></footer>
        <div th:replace="fragments/flash :: flash"></div>
        <div th:replace="individus/modal-update :: update"></div>
    </body>
</html>